<!DOCTYPE html>
<title>index.html</title>
<style>
    html, body {
        background-color: #494949;
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
    }
    
    #editor{
        background-color: #fff;
        width: 100%;
        height: 97%;
    }

</style>
<script src="js/ace.js"></script>
<script src="js/mode-markdown.js"></script>
<script src="js/markdown.js"></script>
<script src="js/markdown.html5.js"></script>
<script src="js/markdown.gfm.js"></script>
<script src="js/ace.highlight.js"></script>
<body>
    <button id="button-preview">preview</button>
    <div id="editor"></div>
<script>
    window.onload = function () {
        var origin = location.protocol + '//' + location.host;
        var previewWindow;
        var button = document.querySelector("#button-preview");

        editor = ace.edit('editor');
        editor.getSession().setMode('ace/mode/markdown');

        document.querySelector('.ace_sb').addEventListener('scroll', function () {
            send({scroll: (this.scrollTop / this.scrollHeight)});
        }, false);

        function send (message) {
            if(previewWindow) previewWindow.postMessage(message, origin);
        }

        var timer;
        editor.getSession().on('change', function() {
            console.log('change!');
            if (timer) clearTimeout(timer);
            timer = setTimeout(function () {
                send({preview: editor.getValue()});
            }, 750);
        });
        
        button.addEventListener('click', function(e) {
            previewWindow = window.open('./view.html', '', 'width=800,height=600');
            previewWindow.addEventListener('load', function() {
                send({preview: editor.getValue()});
            }, false);
        }, false);



        function save (argument) {
            // body...
        }

        function load (argument) {
            // body...
        }

        function createEpub (argument) {
            // body...
        }
    };
</script>
</body>
